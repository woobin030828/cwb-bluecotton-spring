<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.bluecotton.mapper.PostMapper">

    <!-- 오늘의 솜 메인페이지 게시글 리스트 조회 (+ 좋아요 여부 포함) -->
    <select id="select" parameterType="map" resultType="com.app.bluecotton.domain.dto.post.PostMainDTO">
        SELECT
        TBP.ID AS POST_ID,
        TBS.SOM_CATEGORY,
        TBS.SOM_TITLE AS SOM_TITLE,
        TRUNC(TRUNC(SYSDATE) - TRUNC(TBS.SOM_START_DATE)) + 1 AS POST_SOM_DAY,
        TBP.POST_TITLE,
        TBP.POST_CONTENT,
        TBM.MEMBER_NICKNAME,
        NVL(TBMP.MEMBER_PROFILE_PATH || TBMP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,
        TBP.POST_CREATE_AT,
        TBP.POST_READ_COUNT,
        NVL(TPI.POST_IMAGE_PATH || TPI.POST_IMAGE_NAME, '/upload/default/default_post.jpg') AS POST_IMAGE_URL,
        (SELECT COUNT(*) FROM TBL_POST_LIKE L WHERE L.POST_ID = TBP.ID) AS POST_LIKE_COUNT,
        (
        SELECT COUNT(*) FROM TBL_POST_COMMENT C WHERE C.POST_ID = TBP.ID
        ) +
        (
        SELECT COUNT(*) FROM TBL_POST_REPLY R
        WHERE R.POST_COMMENT_ID IN (
        SELECT ID FROM TBL_POST_COMMENT WHERE POST_ID = TBP.ID
        )
        ) AS POST_COMMENT_COUNT,
        CASE
        WHEN EXISTS (
        SELECT 1 FROM TBL_POST_LIKE L
        WHERE L.POST_ID = TBP.ID AND L.MEMBER_ID = #{memberId}
        ) THEN 1
        ELSE 0
        END AS POST_IS_LIKE

        FROM TBL_POST TBP
        JOIN TBL_MEMBER TBM ON TBP.MEMBER_ID = TBM.ID
        LEFT JOIN TBL_SOM TBS ON TBP.SOM_ID = TBS.ID
        LEFT JOIN TBL_MEMBER_PROFILE TBMP ON TBM.ID = TBMP.MEMBER_ID
        LEFT JOIN TBL_POST_IMAGE TPI ON TBP.ID = TPI.POST_ID

        WHERE 1=1
        <if test="somCategory != null and somCategory != ''">
            AND UPPER(TBS.SOM_CATEGORY) = UPPER(#{somCategory})
        </if>

        <choose>
            <when test="orderType == 'view'">
                ORDER BY TBP.POST_READ_COUNT DESC, TBP.ID DESC
            </when>
            <when test="orderType == 'popular'">
                ORDER BY POST_LIKE_COUNT DESC, TBP.ID DESC
            </when>
            <when test="orderType == 'comment'">
                ORDER BY POST_COMMENT_COUNT DESC, TBP.ID DESC
            </when>
            <otherwise>
                ORDER BY TBP.POST_CREATE_AT DESC, TBP.ID DESC
            </otherwise>
        </choose>
    </select>

    <!-- 게시글 등록 -->
    <insert id="insert" parameterType="com.app.bluecotton.domain.vo.post.PostVO">
        <selectKey keyProperty="id" order="BEFORE" resultType="long">
            SELECT SEQ_POST.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TBL_POST (
        ID, POST_TITLE, POST_CONTENT, POST_CREATE_AT,
        POST_READ_COUNT, POST_STATUS, MEMBER_ID, SOM_ID
        ) VALUES (
        #{id}, #{postTitle}, #{postContent},
        SYSTIMESTAMP, 0, 'Y', #{memberId}, #{somId}
        )
    </insert>

    <!-- 특정 회원이 오늘 특정 솜(SOM_ID)에 이미 게시했는지 확인 -->
    <select id="existsTodayPostInSom" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST
        WHERE MEMBER_ID = #{memberId}
        AND SOM_ID = #{somId}
        AND POST_STATUS = 'Y'
        AND TRUNC(POST_CREATE_AT) = TRUNC(SYSDATE)
    </select>

    <!-- 업로드된 이미지 → 게시글 ID 매핑 -->
    <update id="updatePostIdByUrl">
        UPDATE TBL_POST_IMAGE
        SET POST_ID = #{postId}
        WHERE POST_IMAGE_PATH || POST_IMAGE_NAME = #{url}
    </update>

    <!-- 기본 이미지 등록 -->
    <insert id="insertDefaultImage">
        INSERT INTO TBL_POST_IMAGE (
        ID, POST_IMAGE_PATH, POST_IMAGE_NAME, POST_ID
        ) VALUES (
        SEQ_POST_IMAGE.NEXTVAL,
        #{postImagePath}, #{postImageName}, #{postId}
        )
    </insert>

    <!-- 첫 번째 이미지를 대표 썸네일로 등록 -->
    <insert id="insertThumbnail">
        INSERT INTO TBL_POST_IMAGE (
        ID, POST_IMAGE_PATH, POST_IMAGE_NAME, POST_ID
        ) VALUES (
        SEQ_POST_IMAGE.NEXTVAL,
        #{postImagePath}, #{postImageName}, #{postId}
        )
    </insert>


    <!-- [게시글 등록용] 회원이 참여 중인 솜 목록 조회 -->
    <select id="findJoinedSomsByMemberId" parameterType="long" resultType="com.app.bluecotton.domain.dto.post.SomCategoryDTO">
        SELECT
        S.ID AS SOM_ID,
        S.SOM_CATEGORY
        FROM TBL_SOM S
        JOIN TBL_SOM_PARTICIPANT SP ON S.ID = SP.SOM_ID
        WHERE SP.MEMBER_ID = #{memberId}
    </select>


    <select id="findByIdForUpdate" parameterType="long" resultType="com.app.bluecotton.domain.dto.post.PostModifyDTO">
        SELECT
        P.ID AS POST_ID,
        P.POST_TITLE AS POST_TITLE,
        P.POST_CONTENT AS POST_CONTENT,
        P.MEMBER_ID AS MEMBER_ID,
        P.SOM_ID AS SOM_ID,
        S.SOM_CATEGORY AS SOM_CATEGORY
        FROM TBL_POST P
        JOIN TBL_SOM S ON P.SOM_ID = S.ID
        WHERE P.ID = #{id}
    </select>

    <!-- [게시글 수정용] 회원이 참여 중인 솜 목록 조회 (수정 드롭다운용) -->
    <select id="findJoinedCategories" parameterType="long" resultType="com.app.bluecotton.domain.dto.post.SomCategoryDTO">
        SELECT
        S.ID AS SOM_ID,
        S.SOM_CATEGORY
        FROM TBL_SOM S
        JOIN TBL_SOM_JOIN SJ ON S.ID = SJ.SOM_ID
        WHERE SJ.MEMBER_ID = #{memberId}
    </select>

    <!-- [게시글 수정 처리] -->
    <update id="update" parameterType="com.app.bluecotton.domain.vo.post.PostVO">
        UPDATE TBL_POST
        SET
        POST_TITLE = #{postTitle},
        POST_CONTENT = #{postContent},
        SOM_ID = #{somId}
        WHERE ID = #{id}
    </update>

    <!-- 삭제 관련 -->
    <delete id="deletePostById" parameterType="Long">
        DELETE FROM TBL_POST WHERE ID = #{id}
    </delete>

    <delete id="deleteLikesByPostId" parameterType="long">
        DELETE FROM TBL_POST_LIKE WHERE POST_ID = #{postId}
    </delete>

    <delete id="deleteCommentsByPostId" parameterType="long">
        DELETE FROM TBL_POST_COMMENT WHERE POST_ID = #{postId}
    </delete>

    <delete id="deleteRepliesByPostId" parameterType="long">
        DELETE FROM TBL_POST_REPLY
        WHERE POST_COMMENT_ID IN (
        SELECT ID FROM TBL_POST_COMMENT WHERE POST_ID = #{postId}
        )
    </delete>

    <delete id="deletePostImages" parameterType="long">
        DELETE FROM TBL_POST_IMAGE WHERE POST_ID = #{postId}
    </delete>

    <delete id="deleteReportsByPostId" parameterType="long">
        DELETE FROM TBL_POST_REPORT WHERE POST_ID = #{postId}
    </delete>

    <delete id="deleteRecectsByPostId" parameterType="long">
        DELETE FROM TBL_POST_RECENT WHERE POST_ID = #{postId}
    </delete>

    <!-- 임시저장 등록 -->
    <insert id="insertDraft" parameterType="com.app.bluecotton.domain.vo.post.PostDraftVO">
        INSERT INTO TBL_POST_DRAFT (
        ID, POST_DRAFT_TITLE, POST_DRAFT_CONTENT, MEMBER_ID, SOM_ID
        ) VALUES (
        SEQ_POST_DRAFT.NEXTVAL, #{postDraftTitle},
        #{postDraftContent}, #{memberId}, #{somId}
        )
    </insert>

</mapper>
